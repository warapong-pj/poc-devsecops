name: quality scan

on:
  push: {}

jobs:
  sast:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5
      # - uses: actions/setup-python@v6
      #   with:
      #     python-version: '3.10'
      - uses: actions/setup-java@v5
        with:
          distribution: 'adopt'
          java-version: '21'

      - run: |
          #!/bin/sh

          set -xe

          export SONAR_SCANNER_VERSION=7.2.0.5079
          export SONAR_SCANNER_HOME=$HOME/.sonar/sonar-scanner-$SONAR_SCANNER_VERSION-linux-x64
          curl --create-dirs -sSLo $HOME/.sonar/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$SONAR_SCANNER_VERSION-linux-x64.zip
          unzip -o $HOME/.sonar/sonar-scanner.zip -d $HOME/.sonar/
          export PATH=$SONAR_SCANNER_HOME/bin:$PATH

          sonar-scanner -Dsonar.organization=warapong-pj -Dsonar.projectKey=warapong-pj_poc-devsecops -Dsonar.token=${{ secrets.SONAR_TOKEN }}

      # - run: |
      #     #!/bin/sh

      #     set -xe

      #     mkdir -p $HOME/codeql-home
      #     git clone --recursive https://github.com/github/codeql.git $HOME/codeql-home/codeql-repo
      #     curl -fsSL https://github.com/github/codeql-cli-binaries/releases/download/v2.22.4/codeql-linux64.zip -o codeql-linux64.zip
      #     unzip -q codeql-linux64.zip -d $HOME/codeql-home
      #     rm codeql-linux64.zip
      #     export PATH=$PATH:$HOME/codeql-home/codeql
      #     pip install sarif-tools
      #     codeql database create --language=python codeql-db --source-root=.
      #     codeql database analyze codeql-db python-code-quality --format=sarif-latest --output=codeql.sarif
      #     sarif csv codeql.sarif
      #     cat codeql.csv

  sca:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5
      # - uses: actions/setup-java@v5
      #   with:
      #     distribution: 'adopt'
      #     java-version: '21'

      # - run: |
      #     #!/bin/sh

      #     set -xe

      #     curl -fsSL https://github.com/dependency-check/DependencyCheck/releases/download/v12.1.3/dependency-check-12.1.3-release.zip -o dependency-check.zip
      #     unzip -q dependency-check.zip -d $HOME
      #     rm dependency-check.zip
      #     export PATH=$PATH:$HOME/dependency-check/bin
      #     dependency-check.sh --scan ./ --out ./dependency-check-report --enableExperimental --nvdApiKey 07bc69b2-9b41-4ec4-bae5-7f47184ecf86
      #     cat dependency-check-report/dependency-check-report.html

      #     trivy fs --format sarif -o report-sca.sarif .
      
      - run: |
          #!/bin/sh

          set -xe

          git clone https://github.com/CycloneDX/Sunshine.git
          cd Sunshine
          pip install -r requirements.txt

          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

          trivy fs --format cyclonedx --output cyclonedx-result-sca.json .

          python sunshine.py -i cyclonedx-result-sca.json -o cyclonedx-result-sca.html
          cat cyclonedx-result-sca.html
